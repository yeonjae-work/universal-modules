name: Universal Modules CI/CD

on:
  push:
    branches: [ main, develop ]
    paths:
      - 'packages/**'
      - '.github/workflows/**'
  pull_request:
    branches: [ main ]
    paths:
      - 'packages/**'
  release:
    types: [ published ]

env:
  PYTHON_VERSION: '3.11'

jobs:
  # ë³€ê²½ëœ ëª¨ë“ˆ ê°ì§€
  detect-changes:
    name: "ë³€ê²½ëœ ëª¨ë“ˆ ê°ì§€"
    runs-on: ubuntu-latest
    outputs:
      changed-modules: ${{ steps.changes.outputs.modules }}
      matrix: ${{ steps.changes.outputs.matrix }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: ë³€ê²½ëœ ëª¨ë“ˆ ê°ì§€
        id: changes
        run: |
          # ë³€ê²½ëœ íŒŒì¼ ëª©ë¡ ê°€ì ¸ì˜¤ê¸°
          if [ "${{ github.event_name }}" = "pull_request" ]; then
            CHANGED_FILES=$(git diff --name-only ${{ github.event.pull_request.base.sha }} ${{ github.sha }})
          else
            CHANGED_FILES=$(git diff --name-only HEAD~1 HEAD)
          fi
          
          echo "ë³€ê²½ëœ íŒŒì¼ë“¤:"
          echo "$CHANGED_FILES"
          
          # ë³€ê²½ëœ ëª¨ë“ˆ ì¶”ì¶œ
          MODULES=$(echo "$CHANGED_FILES" | grep "^packages/" | cut -d'/' -f2 | sort -u | tr '\n' ' ')
          
          if [ -z "$MODULES" ]; then
            echo "ë³€ê²½ëœ ëª¨ë“ˆì´ ì—†ìŠµë‹ˆë‹¤."
            echo "modules=" >> $GITHUB_OUTPUT
            echo "matrix={\"include\":[]}" >> $GITHUB_OUTPUT
          else
            echo "ë³€ê²½ëœ ëª¨ë“ˆ: $MODULES"
            echo "modules=$MODULES" >> $GITHUB_OUTPUT
            
            # Matrix ì „ëµì„ ìœ„í•œ JSON ìƒì„±
            MATRIX_JSON="{\"include\":["
            FIRST=true
            for module in $MODULES; do
              if [ "$FIRST" = true ]; then
                FIRST=false
              else
                MATRIX_JSON="$MATRIX_JSON,"
              fi
              MATRIX_JSON="$MATRIX_JSON{\"module\":\"$module\"}"
            done
            MATRIX_JSON="$MATRIX_JSON]}"
            
            echo "matrix=$MATRIX_JSON" >> $GITHUB_OUTPUT
          fi

  # ì½”ë“œ í’ˆì§ˆ ê²€ì‚¬
  quality-check:
    name: "ì½”ë“œ í’ˆì§ˆ ê²€ì‚¬"
    runs-on: ubuntu-latest
    needs: detect-changes
    if: needs.detect-changes.outputs.changed-modules != ''
    strategy:
      matrix: ${{ fromJson(needs.detect-changes.outputs.matrix) }}
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Python í™˜ê²½ ì„¤ì •
        uses: actions/setup-python@v4
        with:
          python-version: ${{ env.PYTHON_VERSION }}
      
      - name: Cache pip dependencies
        uses: actions/cache@v3
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-${{ hashFiles('packages/${{ matrix.module }}/pyproject.toml') }}
          restore-keys: |
            ${{ runner.os }}-pip-
      
      - name: Install dependencies
        run: |
          cd packages/${{ matrix.module }}
          python -m pip install --upgrade pip
          pip install -e ".[dev]"
      
      - name: Code formatting check (Black)
        run: |
          cd packages/${{ matrix.module }}
          black --check --diff src/ tests/
      
      - name: Import sorting check (isort)
        run: |
          cd packages/${{ matrix.module }}
          isort --check-only --diff src/ tests/
      
      - name: Linting (Flake8)
        run: |
          cd packages/${{ matrix.module }}
          flake8 src/ tests/ --max-line-length=88 --extend-ignore=E203,W503
      
      - name: Type checking (MyPy)
        run: |
          cd packages/${{ matrix.module }}
          mypy src/ --ignore-missing-imports
      
      - name: Security check (Bandit)
        run: |
          cd packages/${{ matrix.module }}
          bandit -r src/ -f json -o bandit-report.json || true
      
      - name: Upload security report
        uses: actions/upload-artifact@v3
        with:
          name: security-report-${{ matrix.module }}
          path: packages/${{ matrix.module }}/bandit-report.json

  # í…ŒìŠ¤íŠ¸ ì‹¤í–‰
  test:
    name: "í…ŒìŠ¤íŠ¸ ì‹¤í–‰"
    runs-on: ubuntu-latest
    needs: [detect-changes, quality-check]
    if: needs.detect-changes.outputs.changed-modules != ''
    strategy:
      matrix: 
        python-version: ["3.9", "3.10", "3.11", "3.12"]
        module: ${{ fromJson(needs.detect-changes.outputs.changed-modules) }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Python ${{ matrix.python-version }} ì„¤ì •
        uses: actions/setup-python@v4
        with:
          python-version: ${{ matrix.python-version }}
      
      - name: Cache pip dependencies
        uses: actions/cache@v3
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-${{ matrix.python-version }}-pip-${{ hashFiles('packages/${{ matrix.module }}/pyproject.toml') }}
      
      - name: Install dependencies
        run: |
          cd packages/${{ matrix.module }}
          python -m pip install --upgrade pip
          pip install -e ".[dev]"
      
      - name: Run tests with coverage
        run: |
          cd packages/${{ matrix.module }}
          pytest tests/ -v --cov=src/ --cov-report=xml --cov-report=term
      
      - name: Upload coverage to Codecov
        if: matrix.python-version == env.PYTHON_VERSION
        uses: codecov/codecov-action@v3
        with:
          file: packages/${{ matrix.module }}/coverage.xml
          flags: ${{ matrix.module }}
          name: ${{ matrix.module }}-coverage
      
      - name: Upload test results
        uses: actions/upload-artifact@v3
        if: always()
        with:
          name: test-results-${{ matrix.module }}-${{ matrix.python-version }}
          path: |
            packages/${{ matrix.module }}/pytest-results.xml
            packages/${{ matrix.module }}/htmlcov/

  # ì„±ëŠ¥ í…ŒìŠ¤íŠ¸
  performance-test:
    name: "ì„±ëŠ¥ í…ŒìŠ¤íŠ¸"
    runs-on: ubuntu-latest
    needs: [detect-changes, test]
    if: needs.detect-changes.outputs.changed-modules != ''
    strategy:
      matrix: ${{ fromJson(needs.detect-changes.outputs.matrix) }}
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Python í™˜ê²½ ì„¤ì •
        uses: actions/setup-python@v4
        with:
          python-version: ${{ env.PYTHON_VERSION }}
      
      - name: Install dependencies
        run: |
          cd packages/${{ matrix.module }}
          python -m pip install --upgrade pip
          pip install -e ".[dev]" pytest-benchmark
      
      - name: Run performance tests
        run: |
          cd packages/${{ matrix.module }}
          if [ -f "tests/test_performance.py" ]; then
            pytest tests/test_performance.py --benchmark-json=benchmark.json
          else
            echo "No performance tests found for ${{ matrix.module }}"
          fi
      
      - name: Upload benchmark results
        uses: actions/upload-artifact@v3
        with:
          name: benchmark-${{ matrix.module }}
          path: packages/${{ matrix.module }}/benchmark.json

  # ë¬¸ì„œ ìƒì„±
  documentation:
    name: "ë¬¸ì„œ ìƒì„±"
    runs-on: ubuntu-latest
    needs: [detect-changes, test]
    if: needs.detect-changes.outputs.changed-modules != ''
    strategy:
      matrix: ${{ fromJson(needs.detect-changes.outputs.matrix) }}
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Python í™˜ê²½ ì„¤ì •
        uses: actions/setup-python@v4
        with:
          python-version: ${{ env.PYTHON_VERSION }}
      
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install sphinx sphinx-rtd-theme myst-parser
          cd packages/${{ matrix.module }}
          pip install -e ".[dev]"
      
      - name: Generate API documentation
        run: |
          cd packages/${{ matrix.module }}
          mkdir -p docs/api
          sphinx-apidoc -o docs/api src/
      
      - name: Update module documentation
        run: |
          python scripts/update-documentation.py ${{ matrix.module }}
      
      - name: Build documentation
        run: |
          cd packages/${{ matrix.module }}
          if [ -f "docs/conf.py" ]; then
            sphinx-build -b html docs docs/_build/html
          fi
      
      - name: Upload documentation
        uses: actions/upload-artifact@v3
        with:
          name: docs-${{ matrix.module }}
          path: packages/${{ matrix.module }}/docs/_build/html/

  # ë¹Œë“œ ë° íŒ¨í‚¤ì§•
  build:
    name: "íŒ¨í‚¤ì§€ ë¹Œë“œ"
    runs-on: ubuntu-latest
    needs: [detect-changes, test, quality-check]
    if: needs.detect-changes.outputs.changed-modules != ''
    strategy:
      matrix: ${{ fromJson(needs.detect-changes.outputs.matrix) }}
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Python í™˜ê²½ ì„¤ì •
        uses: actions/setup-python@v4
        with:
          python-version: ${{ env.PYTHON_VERSION }}
      
      - name: Install build dependencies
        run: |
          python -m pip install --upgrade pip
          pip install build twine
      
      - name: Build package
        run: |
          cd packages/${{ matrix.module }}
          python -m build
      
      - name: Check package
        run: |
          cd packages/${{ matrix.module }}
          twine check dist/*
      
      - name: Upload build artifacts
        uses: actions/upload-artifact@v3
        with:
          name: ${{ matrix.module }}-dist
          path: packages/${{ matrix.module }}/dist/

  # ë³´ì•ˆ ìŠ¤ìº”
  security-scan:
    name: "ë³´ì•ˆ ìŠ¤ìº”"
    runs-on: ubuntu-latest
    needs: [detect-changes, build]
    if: needs.detect-changes.outputs.changed-modules != ''
    strategy:
      matrix: ${{ fromJson(needs.detect-changes.outputs.matrix) }}
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Python í™˜ê²½ ì„¤ì •
        uses: actions/setup-python@v4
        with:
          python-version: ${{ env.PYTHON_VERSION }}
      
      - name: Install security tools
        run: |
          python -m pip install --upgrade pip
          pip install safety pip-audit
      
      - name: Check dependencies for vulnerabilities
        run: |
          cd packages/${{ matrix.module }}
          pip install -e .
          safety check --json --output safety-report.json || true
          pip-audit --format=json --output=pip-audit-report.json || true
      
      - name: Upload security reports
        uses: actions/upload-artifact@v3
        with:
          name: security-scan-${{ matrix.module }}
          path: |
            packages/${{ matrix.module }}/safety-report.json
            packages/${{ matrix.module }}/pip-audit-report.json

  # ë°°í¬ (ë©”ì¸ ë¸Œëœì¹˜ í‘¸ì‹œ ì‹œ)
  deploy:
    name: "PyPI ë°°í¬"
    runs-on: ubuntu-latest
    needs: [detect-changes, test, quality-check, build, security-scan]
    if: |
      needs.detect-changes.outputs.changed-modules != '' &&
      github.ref == 'refs/heads/main' &&
      github.event_name == 'push'
    strategy:
      matrix: ${{ fromJson(needs.detect-changes.outputs.matrix) }}
    

    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: Python í™˜ê²½ ì„¤ì •
        uses: actions/setup-python@v4
        with:
          python-version: ${{ env.PYTHON_VERSION }}
      
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install twine semver toml
      
      - name: Download build artifacts
        uses: actions/download-artifact@v3
        with:
          name: ${{ matrix.module }}-dist
          path: packages/${{ matrix.module }}/dist/
      
      - name: Check if version changed
        id: version-check
        run: |
          cd packages/${{ matrix.module }}
          current_version=$(python -c "import toml; print(toml.load('pyproject.toml')['project']['version'])")
          
          # ì´ì „ íƒœê·¸ì™€ ë¹„êµ
          latest_tag=$(git tag -l "${{ matrix.module }}-v*" --sort=-version:refname | head -n1)
          if [ -n "$latest_tag" ]; then
            latest_version=${latest_tag#${{ matrix.module }}-v}
            if [ "$current_version" != "$latest_version" ]; then
              echo "version-changed=true" >> $GITHUB_OUTPUT
              echo "new-version=$current_version" >> $GITHUB_OUTPUT
            else
              echo "version-changed=false" >> $GITHUB_OUTPUT
            fi
          else
            echo "version-changed=true" >> $GITHUB_OUTPUT
            echo "new-version=$current_version" >> $GITHUB_OUTPUT
          fi
      
      - name: Create Git tag
        if: steps.version-check.outputs.version-changed == 'true'
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git tag -a "${{ matrix.module }}-v${{ steps.version-check.outputs.new-version }}" -m "${{ matrix.module }} v${{ steps.version-check.outputs.new-version }}"
          git push origin "${{ matrix.module }}-v${{ steps.version-check.outputs.new-version }}"
      
      - name: Publish to PyPI
        if: steps.version-check.outputs.version-changed == 'true'
        env:
          TWINE_USERNAME: __token__
          TWINE_PASSWORD: ${{ secrets.PYPI_API_TOKEN }}
        run: |
          cd packages/${{ matrix.module }}
          twine upload dist/*
      
      - name: Update documentation
        if: steps.version-check.outputs.version-changed == 'true'
        run: |
          python scripts/update-documentation.py ${{ matrix.module }} --version=${{ steps.version-check.outputs.new-version }}
      
      - name: Create GitHub Release
        if: steps.version-check.outputs.version-changed == 'true'
        uses: actions/create-release@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: ${{ matrix.module }}-v${{ steps.version-check.outputs.new-version }}
          release_name: ${{ matrix.module }} v${{ steps.version-check.outputs.new-version }}
          body: |
            ## ${{ matrix.module }} v${{ steps.version-check.outputs.new-version }}
            
            ìë™ ìƒì„±ëœ ë¦´ë¦¬ìŠ¤ì…ë‹ˆë‹¤.
            
            ### ì„¤ì¹˜ ë°©ë²•
            ```bash
            pip install universal-${{ matrix.module }}==${{ steps.version-check.outputs.new-version }}
            ```
            
            ### ë³€ê²½ì‚¬í•­
            ì´ ë¦´ë¦¬ìŠ¤ì˜ ìƒì„¸í•œ ë³€ê²½ì‚¬í•­ì€ [ë¬¸ì„œ](https://github.com/${{ github.repository }}/blob/main/packages/${{ matrix.module }}/CHANGELOG.md)ë¥¼ ì°¸ì¡°í•˜ì„¸ìš”.
          draft: false
          prerelease: false

  # ì•Œë¦¼
  notify:
    name: "ë°°í¬ ì•Œë¦¼"
    runs-on: ubuntu-latest
    needs: [detect-changes, deploy]
    if: always() && needs.detect-changes.outputs.changed-modules != ''
    
    steps:
      - name: ë°°í¬ ì„±ê³µ ì•Œë¦¼
        if: needs.deploy.result == 'success'
        run: |
          curl -X POST -H 'Content-type: application/json' \
            --data '{
              "text": "ğŸš€ Universal Modules ë°°í¬ ì„±ê³µ!",
              "blocks": [
                {
                  "type": "header",
                  "text": {
                    "type": "plain_text",
                    "text": "ğŸš€ ë°°í¬ ì™„ë£Œ"
                  }
                },
                {
                  "type": "section",
                  "fields": [
                    {
                      "type": "mrkdwn",
                      "text": "*ë°°í¬ëœ ëª¨ë“ˆ:*\n${{ needs.detect-changes.outputs.changed-modules }}"
                    },
                    {
                      "type": "mrkdwn",
                      "text": "*ë¸Œëœì¹˜:*\n${{ github.ref_name }}"
                    },
                    {
                      "type": "mrkdwn",
                      "text": "*ì»¤ë°‹:*\n<${{ github.server_url }}/${{ github.repository }}/commit/${{ github.sha }}|${{ github.sha }}>"
                    },
                    {
                      "type": "mrkdwn",
                      "text": "*ì‘ì„±ì:*\n${{ github.actor }}"
                    }
                  ]
                },
                {
                  "type": "actions",
                  "elements": [
                    {
                      "type": "button",
                      "text": {
                        "type": "plain_text",
                        "text": "GitHub Actions ë³´ê¸°"
                      },
                      "url": "${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
                    },
                    {
                      "type": "button",
                      "text": {
                        "type": "plain_text",
                        "text": "PyPI í™•ì¸"
                      },
                      "url": "https://pypi.org/search/?q=universal"
                    }
                  ]
                }
              ]
            }' \
            ${{ secrets.SLACK_WEBHOOK_URL }}

      - name: ë°°í¬ ì‹¤íŒ¨ ì•Œë¦¼
        if: needs.deploy.result == 'failure'
        run: |
          curl -X POST -H 'Content-type: application/json' \
            --data '{
              "text": "âŒ Universal Modules ë°°í¬ ì‹¤íŒ¨!",
              "blocks": [
                {
                  "type": "header",
                  "text": {
                    "type": "plain_text",
                    "text": "âŒ ë°°í¬ ì‹¤íŒ¨"
                  }
                },
                {
                  "type": "section",
                  "fields": [
                    {
                      "type": "mrkdwn",
                      "text": "*ì‹¤íŒ¨í•œ ëª¨ë“ˆ:*\n${{ needs.detect-changes.outputs.changed-modules }}"
                    },
                    {
                      "type": "mrkdwn",
                      "text": "*ë¸Œëœì¹˜:*\n${{ github.ref_name }}"
                    },
                    {
                      "type": "mrkdwn",
                      "text": "*ì»¤ë°‹:*\n<${{ github.server_url }}/${{ github.repository }}/commit/${{ github.sha }}|${{ github.sha }}>"
                    },
                    {
                      "type": "mrkdwn",
                      "text": "*ì‘ì„±ì:*\n${{ github.actor }}"
                    }
                  ]
                },
                {
                  "type": "section",
                  "text": {
                    "type": "mrkdwn",
                    "text": "ğŸ” *ë¡œê·¸ í™•ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.*"
                  }
                },
                {
                  "type": "actions",
                  "elements": [
                    {
                      "type": "button",
                      "text": {
                        "type": "plain_text",
                        "text": "ë¡œê·¸ í™•ì¸í•˜ê¸°"
                      },
                      "url": "${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}",
                      "style": "danger"
                    }
                  ]
                }
              ]
            }' \
            ${{ secrets.SLACK_WEBHOOK_URL }}

      - name: í…ŒìŠ¤íŠ¸ ì‹¤íŒ¨ ì•Œë¦¼
        if: needs.deploy.result == 'skipped' && contains(needs.*.result, 'failure')
        run: |
          curl -X POST -H 'Content-type: application/json' \
            --data '{
              "text": "âš ï¸ Universal Modules í…ŒìŠ¤íŠ¸ ì‹¤íŒ¨!",
              "blocks": [
                {
                  "type": "header",
                  "text": {
                    "type": "plain_text",
                    "text": "âš ï¸ í…ŒìŠ¤íŠ¸ ì‹¤íŒ¨"
                  }
                },
                {
                  "type": "section",
                  "text": {
                    "type": "mrkdwn",
                    "text": "*ëª¨ë“ˆ:* ${{ needs.detect-changes.outputs.changed-modules }}\n*ë¸Œëœì¹˜:* ${{ github.ref_name }}\n*ì‘ì„±ì:* ${{ github.actor }}"
                  }
                },
                {
                  "type": "actions",
                  "elements": [
                    {
                      "type": "button",
                      "text": {
                        "type": "plain_text",
                        "text": "í…ŒìŠ¤íŠ¸ ë¡œê·¸ ë³´ê¸°"
                      },
                      "url": "${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}",
                      "style": "primary"
                    }
                  ]
                }
              ]
            }' \
            ${{ secrets.SLACK_WEBHOOK_URL }}

  # ë©”íŠ¸ë¦­ ìˆ˜ì§‘
  metrics:
    name: "ë©”íŠ¸ë¦­ ìˆ˜ì§‘"
    runs-on: ubuntu-latest
    needs: [test, performance-test]
    if: always() && needs.detect-changes.outputs.changed-modules != ''
    
    steps:
      - name: Collect metrics
        run: |
          echo "Collecting CI/CD metrics..."
          # ë©”íŠ¸ë¦­ ìˆ˜ì§‘ ë¡œì§ ì¶”ê°€
          # ì˜ˆ: í…ŒìŠ¤íŠ¸ ì‹œê°„, ë¹Œë“œ ì‹œê°„, ì»¤ë²„ë¦¬ì§€ ë“±
      
      - name: Send metrics to monitoring
        run: |
          echo "Sending metrics to monitoring system..."
          # ëª¨ë‹ˆí„°ë§ ì‹œìŠ¤í…œìœ¼ë¡œ ë©”íŠ¸ë¦­ ì „ì†¡ 