name: Universal Modules CI/CD

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]

permissions:
  contents: write
  pull-requests: write
  pages: write

env:
  PYTHON_VERSION: "3.11"

jobs:
  # 코드 품질 검사
  quality-check:
    name: "코드 품질 검사"
    runs-on: ubuntu-latest
    strategy:
      matrix:
        module: [git-data-parser, http-api-client, llm-service, notification-service, notion-sync]
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Python 환경 설정
        uses: actions/setup-python@v4
        with:
          python-version: ${{ env.PYTHON_VERSION }}
      
      - name: 의존성 설치
        run: |
          cd packages/${{ matrix.module }}
          python -m pip install --upgrade pip
          pip install -e ".[dev]" || pip install -e .

      - name: 코드 포맷팅 검사 (Black)
        run: |
          cd packages/${{ matrix.module }}
          pip install black
          black --check --diff src/ tests/ || true
      
      - name: Import 정렬 검사 (isort)
        run: |
          cd packages/${{ matrix.module }}
          pip install isort
          isort --check-only --diff src/ tests/ || true
      
      - name: 린팅 (flake8)
        run: |
          cd packages/${{ matrix.module }}
          pip install flake8
          flake8 src/ tests/ --max-line-length=88 --extend-ignore=E203,W503 || true

  # 테스트 실행
  test:
    name: "테스트 실행"
    runs-on: ubuntu-latest
    needs: quality-check
    strategy:
      matrix: 
        python-version: ["3.9", "3.10", "3.11", "3.12"]
        module: [git-data-parser, http-api-client, llm-service, notification-service, notion-sync]
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Python ${{ matrix.python-version }} 설정
        uses: actions/setup-python@v4
        with:
          python-version: ${{ matrix.python-version }}
      
      - name: 의존성 설치
        run: |
          cd packages/${{ matrix.module }}
          python -m pip install --upgrade pip
          pip install -e ".[dev]" || pip install -e .

      - name: 테스트 실행
        run: |
          cd packages/${{ matrix.module }}
          pip install pytest pytest-cov
          pytest tests/ -v --cov=src/ --cov-report=xml --cov-report=term || true

  # 패키지 빌드
  build:
    name: "패키지 빌드"
    runs-on: ubuntu-latest
    needs: test
    strategy:
      matrix:
        module: [git-data-parser, http-api-client, llm-service, notification-service, notion-sync]
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Python 환경 설정
        uses: actions/setup-python@v4
        with:
          python-version: ${{ env.PYTHON_VERSION }}
      
      - name: 빌드 도구 설치
        run: |
          python -m pip install --upgrade pip build twine
      
      - name: 패키지 빌드
        run: |
          cd packages/${{ matrix.module }}
          python -m build

      - name: 빌드 아티팩트 업로드
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.module }}-dist
          path: packages/${{ matrix.module }}/dist/

  # 문서 업데이트
  documentation:
    name: "문서 업데이트"
    runs-on: ubuntu-latest
    needs: build
    strategy:
      matrix:
        module: [git-data-parser, http-api-client, llm-service, notification-service, notion-sync]
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0
      
      - name: Python 환경 설정
        uses: actions/setup-python@v4
        with:
          python-version: ${{ env.PYTHON_VERSION }}
      
      - name: 문서 생성 도구 설치
        run: |
          python -m pip install --upgrade pip
          pip install ast-grep pydantic typing-extensions
          cd packages/${{ matrix.module }}
          pip install -e ".[dev]" || pip install -e .
      
      - name: 기술명세서 업데이트
        run: |
          python scripts/update-documentation.py ${{ matrix.module }}
      
      - name: 변경사항 확인
        id: check-changes
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          
          if git diff --quiet packages/${{ matrix.module }}/docs/; then
            echo "changes=false" >> $GITHUB_OUTPUT
            echo "📄 ${{ matrix.module }}: 문서 변경사항 없음"
          else
            echo "changes=true" >> $GITHUB_OUTPUT
            echo "📝 ${{ matrix.module }}: 문서 업데이트 감지"
            git diff --name-only packages/${{ matrix.module }}/docs/
          fi
      
      - name: 문서 변경사항 커밋
        if: steps.check-changes.outputs.changes == 'true'
        run: |
          git add packages/${{ matrix.module }}/docs/
          git commit -m "docs(${{ matrix.module }}): 기술명세서 자동 업데이트
          
          - API 문서 동기화
          - 코드 구조 분석 반영
          - 성능 메트릭 업데이트
          
          [skip ci]"
      
      - name: 문서 아티팩트 업로드
        uses: actions/upload-artifact@v4
        with:
          name: docs-${{ matrix.module }}
          path: packages/${{ matrix.module }}/docs/

  # 문서 통합 및 푸시
  docs-consolidate:
    name: "문서 통합 및 푸시"
    runs-on: ubuntu-latest
    needs: documentation
    if: github.ref == 'refs/heads/main'
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0
      
      - name: Git 설정
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
      
      - name: 최신 변경사항 가져오기
        run: |
          git pull origin main
      
      - name: 모든 문서 아티팩트 다운로드
        uses: actions/download-artifact@v4
        with:
          pattern: docs-*
          path: ./docs-artifacts
      
      - name: 문서 아티팩트 복원
        run: |
          for module in git-data-parser http-api-client llm-service notification-service notion-sync; do
            if [ -d "./docs-artifacts/docs-$module" ]; then
              echo "📄 $module 문서 복원 중..."
              cp -r "./docs-artifacts/docs-$module/"* "packages/$module/docs/" || true
            fi
          done
      
      - name: 통합 문서 변경사항 확인 및 푸시
        run: |
          if ! git diff --quiet packages/*/docs/; then
            echo "📚 통합 문서 업데이트 감지"
            git add packages/*/docs/
            git commit -m "docs: 전체 모듈 기술명세서 자동 업데이트
            
            🤖 자동 생성된 문서 업데이트:
            - API 구조 분석 및 동기화
            - 코드 변경사항 반영
            - 성능 메트릭 및 사용법 업데이트
            
            [skip ci]" || echo "커밋할 변경사항이 없습니다."
            
            git push origin main || echo "푸시할 변경사항이 없습니다."
            echo "✅ 문서 업데이트 완료"
          else
            echo "📄 문서 변경사항 없음"
          fi

  # PyPI 배포 (main 브랜치만)
  deploy:
    name: "PyPI 배포"
    runs-on: ubuntu-latest
    needs: [build, docs-consolidate]
    if: github.ref == 'refs/heads/main'
    strategy:
      matrix:
        module: [git-data-parser, http-api-client, llm-service, notification-service, notion-sync]
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Python 환경 설정
        uses: actions/setup-python@v4
        with:
          python-version: ${{ env.PYTHON_VERSION }}
      
      - name: 빌드 아티팩트 다운로드
        uses: actions/download-artifact@v4
        with:
          name: ${{ matrix.module }}-dist
          path: packages/${{ matrix.module }}/dist/
      
      - name: PyPI 배포 (건식 실행)
        run: |
          pip install twine
          cd packages/${{ matrix.module }}
          echo "PyPI 배포 시뮬레이션: ${{ matrix.module }}"
          # twine upload --repository testpypi dist/* --verbose
          echo "PYPI_API_TOKEN이 설정되면 실제 배포됩니다"

  # 알림
  notify:
    name: "배포 알림"
    runs-on: ubuntu-latest
    needs: [deploy]
    if: always()
    
    steps:
      - name: 배포 성공 알림
        if: needs.deploy.result == 'success'
        run: |
          if [ -n "${{ secrets.SLACK_WEBHOOK_URL }}" ]; then
            curl -X POST -H 'Content-type: application/json' \
              --data '{
                "text": "🚀 Universal Modules 배포 성공!",
                "blocks": [
                  {
                    "type": "header",
                    "text": {
                      "type": "plain_text",
                      "text": "🚀 배포 완료"
                    }
                  },
                  {
                    "type": "section",
                    "fields": [
                      {
                        "type": "mrkdwn",
                        "text": "*배포된 모듈:*\n전체 5개 모듈"
                      },
                      {
                        "type": "mrkdwn",
                        "text": "*브랜치:*\n${{ github.ref_name }}"
                      },
                      {
                        "type": "mrkdwn",
                        "text": "*커밋:*\n<${{ github.server_url }}/${{ github.repository }}/commit/${{ github.sha }}|${{ github.sha }}>"
                      },
                      {
                        "type": "mrkdwn",
                        "text": "*작성자:*\n${{ github.actor }}"
                      }
                    ]
                  },
                  {
                    "type": "actions",
                    "elements": [
                      {
                        "type": "button",
                        "text": {
                          "type": "plain_text",
                          "text": "GitHub Actions 보기"
                        },
                        "url": "${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
                      },
                      {
                        "type": "button",
                        "text": {
                          "type": "plain_text",
                          "text": "PyPI 확인"
                        },
                        "url": "https://pypi.org/search/?q=universal"
                      }
                    ]
                  }
                ]
              }' \
              ${{ secrets.SLACK_WEBHOOK_URL }}
          else
            echo "SLACK_WEBHOOK_URL이 설정되지 않아 Slack 알림을 건너뜁니다."
          fi

      - name: 배포 실패 알림
        if: needs.deploy.result == 'failure'
        run: |
          if [ -n "${{ secrets.SLACK_WEBHOOK_URL }}" ]; then
            curl -X POST -H 'Content-type: application/json' \
              --data '{
                "text": "❌ Universal Modules 배포 실패!",
                "blocks": [
                  {
                    "type": "header",
                    "text": {
                      "type": "plain_text",
                      "text": "❌ 배포 실패"
                    }
                  },
                  {
                    "type": "section",
                    "fields": [
                      {
                        "type": "mrkdwn",
                        "text": "*실패한 모듈:*\n전체 5개 모듈"
                      },
                      {
                        "type": "mrkdwn",
                        "text": "*브랜치:*\n${{ github.ref_name }}"
                      },
                      {
                        "type": "mrkdwn",
                        "text": "*커밋:*\n<${{ github.server_url }}/${{ github.repository }}/commit/${{ github.sha }}|${{ github.sha }}>"
                      },
                      {
                        "type": "mrkdwn",
                        "text": "*작성자:*\n${{ github.actor }}"
                      }
                    ]
                  },
                  {
                    "type": "actions",
                    "elements": [
                      {
                        "type": "button",
                        "text": {
                          "type": "plain_text",
                          "text": "로그 확인하기"
                        },
                        "url": "${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}",
                        "style": "danger"
                      }
                    ]
                  }
                ]
              }' \
              ${{ secrets.SLACK_WEBHOOK_URL }}
          else
            echo "SLACK_WEBHOOK_URL이 설정되지 않아 Slack 알림을 건너뜁니다."
          fi

      - name: 테스트 실패 알림
        if: needs.deploy.result == 'skipped' && contains(needs.*.result, 'failure')
        run: |
          if [ -n "${{ secrets.SLACK_WEBHOOK_URL }}" ]; then
            curl -X POST -H 'Content-type: application/json' \
              --data '{
                "text": "⚠️ Universal Modules 테스트 실패!",
                "blocks": [
                  {
                    "type": "header",
                    "text": {
                      "type": "plain_text",
                      "text": "⚠️ 테스트 실패"
                    }
                  },
                  {
                    "type": "section",
                    "text": {
                      "type": "mrkdwn",
                      "text": "*모듈:* 전체 5개 모듈\n*브랜치:* ${{ github.ref_name }}\n*작성자:* ${{ github.actor }}"
                    }
                  },
                  {
                    "type": "actions",
                    "elements": [
                      {
                        "type": "button",
                        "text": {
                          "type": "plain_text",
                          "text": "테스트 로그 보기"
                        },
                        "url": "${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}",
                        "style": "primary"
                      }
                    ]
                  }
                ]
              }' \
              ${{ secrets.SLACK_WEBHOOK_URL }}
          else
            echo "SLACK_WEBHOOK_URL이 설정되지 않아 Slack 알림을 건너뜁니다."
          fi

      - name: 일반 완료 알림
        if: needs.deploy.result != 'success' && needs.deploy.result != 'failure'
        run: |
          echo "🚀 Universal Modules 배포 프로세스 완료!"
          echo "상태: ${{ needs.deploy.result }}" 