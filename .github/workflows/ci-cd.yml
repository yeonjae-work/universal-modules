name: Universal Modules CI/CD

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]

permissions:
  contents: write
  pull-requests: write
  pages: write

env:
  PYTHON_VERSION: "3.11"

jobs:
  # ì½”ë“œ í’ˆì§ˆ ê²€ì‚¬
  quality-check:
    name: "ì½”ë“œ í’ˆì§ˆ ê²€ì‚¬"
    runs-on: ubuntu-latest
    strategy:
      matrix:
        module: [git-data-parser, http-api-client, llm-service, notification-service, notion-sync]
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Python í™˜ê²½ ì„¤ì •
        uses: actions/setup-python@v4
        with:
          python-version: ${{ env.PYTHON_VERSION }}
      
      - name: ì˜ì¡´ì„± ì„¤ì¹˜
        run: |
          cd packages/${{ matrix.module }}
          python -m pip install --upgrade pip
          pip install -e ".[dev]" || pip install -e .

      - name: ì½”ë“œ í¬ë§·íŒ… ê²€ì‚¬ (Black)
        run: |
          cd packages/${{ matrix.module }}
          pip install black
          black --check --diff src/ tests/ || true
      
      - name: Import ì •ë ¬ ê²€ì‚¬ (isort)
        run: |
          cd packages/${{ matrix.module }}
          pip install isort
          isort --check-only --diff src/ tests/ || true
      
      - name: ë¦°íŒ… (flake8)
        run: |
          cd packages/${{ matrix.module }}
          pip install flake8
          flake8 src/ tests/ --max-line-length=88 --extend-ignore=E203,W503 || true

  # í…ŒìŠ¤íŠ¸ ì‹¤í–‰
  test:
    name: "í…ŒìŠ¤íŠ¸ ì‹¤í–‰"
    runs-on: ubuntu-latest
    needs: quality-check
    strategy:
      matrix: 
        python-version: ["3.9", "3.10", "3.11", "3.12"]
        module: [git-data-parser, http-api-client, llm-service, notification-service, notion-sync]
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Python ${{ matrix.python-version }} ì„¤ì •
        uses: actions/setup-python@v4
        with:
          python-version: ${{ matrix.python-version }}
      
      - name: ì˜ì¡´ì„± ì„¤ì¹˜
        run: |
          cd packages/${{ matrix.module }}
          python -m pip install --upgrade pip
          pip install -e ".[dev]" || pip install -e .

      - name: í…ŒìŠ¤íŠ¸ ì‹¤í–‰
        run: |
          cd packages/${{ matrix.module }}
          pip install pytest pytest-cov
          pytest tests/ -v --cov=src/ --cov-report=xml --cov-report=term || true

  # íŒ¨í‚¤ì§€ ë¹Œë“œ
  build:
    name: "íŒ¨í‚¤ì§€ ë¹Œë“œ"
    runs-on: ubuntu-latest
    needs: test
    strategy:
      matrix:
        module: [git-data-parser, http-api-client, llm-service, notification-service, notion-sync]
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Python í™˜ê²½ ì„¤ì •
        uses: actions/setup-python@v4
        with:
          python-version: ${{ env.PYTHON_VERSION }}
      
      - name: ë¹Œë“œ ë„êµ¬ ì„¤ì¹˜
        run: |
          python -m pip install --upgrade pip build twine
      
      - name: íŒ¨í‚¤ì§€ ë¹Œë“œ
        run: |
          cd packages/${{ matrix.module }}
          python -m build

      - name: ë¹Œë“œ ì•„í‹°íŒ©íŠ¸ ì—…ë¡œë“œ
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.module }}-dist
          path: packages/${{ matrix.module }}/dist/

  # PyPI ë°°í¬ (main ë¸Œëœì¹˜ë§Œ)
  deploy:
    name: "PyPI ë°°í¬"
    runs-on: ubuntu-latest
    needs: build
    if: github.ref == 'refs/heads/main'
    strategy:
      matrix:
        module: [git-data-parser, http-api-client, llm-service, notification-service, notion-sync]
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Python í™˜ê²½ ì„¤ì •
        uses: actions/setup-python@v4
        with:
          python-version: ${{ env.PYTHON_VERSION }}
      
      - name: ë¹Œë“œ ì•„í‹°íŒ©íŠ¸ ë‹¤ìš´ë¡œë“œ
        uses: actions/download-artifact@v4
        with:
          name: ${{ matrix.module }}-dist
          path: packages/${{ matrix.module }}/dist/
      
      - name: PyPI ë°°í¬ (ê±´ì‹ ì‹¤í–‰)
        run: |
          pip install twine
          cd packages/${{ matrix.module }}
          echo "PyPI ë°°í¬ ì‹œë®¬ë ˆì´ì…˜: ${{ matrix.module }}"
          # twine upload --repository testpypi dist/* --verbose
          echo "PYPI_API_TOKENì´ ì„¤ì •ë˜ë©´ ì‹¤ì œ ë°°í¬ë©ë‹ˆë‹¤"

  # ì•Œë¦¼
  notify:
    name: "ë°°í¬ ì•Œë¦¼"
    runs-on: ubuntu-latest
    needs: [deploy]
    if: always()
    
    steps:
      - name: ë°°í¬ ì„±ê³µ ì•Œë¦¼
        if: needs.deploy.result == 'success'
        run: |
          if [ -n "${{ secrets.SLACK_WEBHOOK_URL }}" ]; then
            curl -X POST -H 'Content-type: application/json' \
              --data '{
                "text": "ğŸš€ Universal Modules ë°°í¬ ì„±ê³µ!",
                "blocks": [
                  {
                    "type": "header",
                    "text": {
                      "type": "plain_text",
                      "text": "ğŸš€ ë°°í¬ ì™„ë£Œ"
                    }
                  },
                  {
                    "type": "section",
                    "fields": [
                      {
                        "type": "mrkdwn",
                        "text": "*ë°°í¬ëœ ëª¨ë“ˆ:*\nì „ì²´ 5ê°œ ëª¨ë“ˆ"
                      },
                      {
                        "type": "mrkdwn",
                        "text": "*ë¸Œëœì¹˜:*\n${{ github.ref_name }}"
                      },
                      {
                        "type": "mrkdwn",
                        "text": "*ì»¤ë°‹:*\n<${{ github.server_url }}/${{ github.repository }}/commit/${{ github.sha }}|${{ github.sha }}>"
                      },
                      {
                        "type": "mrkdwn",
                        "text": "*ì‘ì„±ì:*\n${{ github.actor }}"
                      }
                    ]
                  },
                  {
                    "type": "actions",
                    "elements": [
                      {
                        "type": "button",
                        "text": {
                          "type": "plain_text",
                          "text": "GitHub Actions ë³´ê¸°"
                        },
                        "url": "${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
                      },
                      {
                        "type": "button",
                        "text": {
                          "type": "plain_text",
                          "text": "PyPI í™•ì¸"
                        },
                        "url": "https://pypi.org/search/?q=universal"
                      }
                    ]
                  }
                ]
              }' \
              ${{ secrets.SLACK_WEBHOOK_URL }}
          else
            echo "SLACK_WEBHOOK_URLì´ ì„¤ì •ë˜ì§€ ì•Šì•„ Slack ì•Œë¦¼ì„ ê±´ë„ˆëœë‹ˆë‹¤."
          fi

      - name: ë°°í¬ ì‹¤íŒ¨ ì•Œë¦¼
        if: needs.deploy.result == 'failure'
        run: |
          if [ -n "${{ secrets.SLACK_WEBHOOK_URL }}" ]; then
            curl -X POST -H 'Content-type: application/json' \
              --data '{
                "text": "âŒ Universal Modules ë°°í¬ ì‹¤íŒ¨!",
                "blocks": [
                  {
                    "type": "header",
                    "text": {
                      "type": "plain_text",
                      "text": "âŒ ë°°í¬ ì‹¤íŒ¨"
                    }
                  },
                  {
                    "type": "section",
                    "fields": [
                      {
                        "type": "mrkdwn",
                        "text": "*ì‹¤íŒ¨í•œ ëª¨ë“ˆ:*\nì „ì²´ 5ê°œ ëª¨ë“ˆ"
                      },
                      {
                        "type": "mrkdwn",
                        "text": "*ë¸Œëœì¹˜:*\n${{ github.ref_name }}"
                      },
                      {
                        "type": "mrkdwn",
                        "text": "*ì»¤ë°‹:*\n<${{ github.server_url }}/${{ github.repository }}/commit/${{ github.sha }}|${{ github.sha }}>"
                      },
                      {
                        "type": "mrkdwn",
                        "text": "*ì‘ì„±ì:*\n${{ github.actor }}"
                      }
                    ]
                  },
                  {
                    "type": "actions",
                    "elements": [
                      {
                        "type": "button",
                        "text": {
                          "type": "plain_text",
                          "text": "ë¡œê·¸ í™•ì¸í•˜ê¸°"
                        },
                        "url": "${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}",
                        "style": "danger"
                      }
                    ]
                  }
                ]
              }' \
              ${{ secrets.SLACK_WEBHOOK_URL }}
          else
            echo "SLACK_WEBHOOK_URLì´ ì„¤ì •ë˜ì§€ ì•Šì•„ Slack ì•Œë¦¼ì„ ê±´ë„ˆëœë‹ˆë‹¤."
          fi

      - name: í…ŒìŠ¤íŠ¸ ì‹¤íŒ¨ ì•Œë¦¼
        if: needs.deploy.result == 'skipped' && contains(needs.*.result, 'failure')
        run: |
          if [ -n "${{ secrets.SLACK_WEBHOOK_URL }}" ]; then
            curl -X POST -H 'Content-type: application/json' \
              --data '{
                "text": "âš ï¸ Universal Modules í…ŒìŠ¤íŠ¸ ì‹¤íŒ¨!",
                "blocks": [
                  {
                    "type": "header",
                    "text": {
                      "type": "plain_text",
                      "text": "âš ï¸ í…ŒìŠ¤íŠ¸ ì‹¤íŒ¨"
                    }
                  },
                  {
                    "type": "section",
                    "text": {
                      "type": "mrkdwn",
                      "text": "*ëª¨ë“ˆ:* ì „ì²´ 5ê°œ ëª¨ë“ˆ\n*ë¸Œëœì¹˜:* ${{ github.ref_name }}\n*ì‘ì„±ì:* ${{ github.actor }}"
                    }
                  },
                  {
                    "type": "actions",
                    "elements": [
                      {
                        "type": "button",
                        "text": {
                          "type": "plain_text",
                          "text": "í…ŒìŠ¤íŠ¸ ë¡œê·¸ ë³´ê¸°"
                        },
                        "url": "${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}",
                        "style": "primary"
                      }
                    ]
                  }
                ]
              }' \
              ${{ secrets.SLACK_WEBHOOK_URL }}
          else
            echo "SLACK_WEBHOOK_URLì´ ì„¤ì •ë˜ì§€ ì•Šì•„ Slack ì•Œë¦¼ì„ ê±´ë„ˆëœë‹ˆë‹¤."
          fi

      - name: ì¼ë°˜ ì™„ë£Œ ì•Œë¦¼
        if: needs.deploy.result != 'success' && needs.deploy.result != 'failure'
        run: |
          echo "ğŸš€ Universal Modules ë°°í¬ í”„ë¡œì„¸ìŠ¤ ì™„ë£Œ!"
          echo "ìƒíƒœ: ${{ needs.deploy.result }}" 