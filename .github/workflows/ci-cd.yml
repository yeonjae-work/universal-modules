name: Universal Modules CI/CD

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]

permissions:
  contents: write
  pull-requests: write
  pages: write

env:
  PYTHON_VERSION: "3.11"
  # GitHub ì´ë©”ì¼ ì•Œë¦¼ ë¹„í™œì„±í™”
  ACTIONS_RUNNER_DEBUG: false
  ACTIONS_STEP_DEBUG: false

jobs:
  # ë³€ê²½ëœ ëª¨ë“ˆ ê°ì§€ (ë‹¨ìˆœí™”)
  detect-changes:
    name: "ëª¨ë“ˆ ì²˜ë¦¬ ì¤€ë¹„"
    runs-on: ubuntu-latest
    outputs:
      matrix: ${{ steps.setup.outputs.matrix }}
      has-changes: "true"
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: ëª¨ë“ˆ ë§¤íŠ¸ë¦­ìŠ¤ ì„¤ì •
        id: setup
        run: |
          # ëª¨ë“  ëª¨ë“ˆì„ í•­ìƒ ì²˜ë¦¬
          echo "ğŸ“¦ ëª¨ë“  ëª¨ë“ˆ ì²˜ë¦¬: git-data-parser http-api-client llm-service notification-service notion-sync"
          
          # Matrix ì „ëµì„ ìœ„í•œ JSON ìƒì„±
          matrix_json='{"include":[
            {"module":"git-data-parser"},
            {"module":"http-api-client"},
            {"module":"llm-service"},
            {"module":"notification-service"},
            {"module":"notion-sync"}
          ]}'
          
          echo "matrix=$matrix_json" >> $GITHUB_OUTPUT
          echo "âœ… ë§¤íŠ¸ë¦­ìŠ¤ ì„¤ì • ì™„ë£Œ"

  # ì½”ë“œ í’ˆì§ˆ ê²€ì‚¬
  quality-check:
    name: "ì½”ë“œ í’ˆì§ˆ ê²€ì‚¬"
    runs-on: ubuntu-latest
    needs: detect-changes
    strategy:
      matrix: ${{ fromJson(needs.detect-changes.outputs.matrix) }}
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Python í™˜ê²½ ì„¤ì •
        uses: actions/setup-python@v4
        with:
          python-version: ${{ env.PYTHON_VERSION }}
      
      - name: ì˜ì¡´ì„± ì„¤ì¹˜
        run: |
          cd packages/${{ matrix.module }}
          python -m pip install --upgrade pip
          pip install -e ".[dev]" || pip install -e .

      - name: ì½”ë“œ í¬ë§·íŒ… ê²€ì‚¬ (Black)
        run: |
          cd packages/${{ matrix.module }}
          pip install black
          black --check --diff src/ tests/ || true
      
      - name: Import ì •ë ¬ ê²€ì‚¬ (isort)
        run: |
          cd packages/${{ matrix.module }}
          pip install isort
          isort --check-only --diff src/ tests/ || true
      
      - name: ë¦°íŒ… (flake8)
        run: |
          cd packages/${{ matrix.module }}
          pip install flake8
          flake8 src/ tests/ --max-line-length=88 --extend-ignore=E203,W503 || true

  # í…ŒìŠ¤íŠ¸ ì‹¤í–‰
  test:
    name: "í…ŒìŠ¤íŠ¸ ì‹¤í–‰"
    runs-on: ubuntu-latest
    needs: [detect-changes, quality-check]
    strategy:
      matrix: 
        python-version: ["3.11"]
        include:
          - { module: "git-data-parser" }
          - { module: "http-api-client" }
          - { module: "llm-service" }
          - { module: "notification-service" }
          - { module: "notion-sync" }
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Python ${{ matrix.python-version }} ì„¤ì •
        uses: actions/setup-python@v4
        with:
          python-version: ${{ matrix.python-version }}
      
      - name: ì˜ì¡´ì„± ì„¤ì¹˜
        run: |
          cd packages/${{ matrix.module }}
          python -m pip install --upgrade pip
          pip install -e ".[dev]" || pip install -e .

      - name: í…ŒìŠ¤íŠ¸ ì‹¤í–‰
        run: |
          cd packages/${{ matrix.module }}
          pip install pytest pytest-cov
          pytest tests/ -v --cov=src/ --cov-report=xml --cov-report=term || true

  # íŒ¨í‚¤ì§€ ë¹Œë“œ
  build:
    name: "íŒ¨í‚¤ì§€ ë¹Œë“œ"
    runs-on: ubuntu-latest
    needs: [detect-changes, test]
    strategy:
      matrix: ${{ fromJson(needs.detect-changes.outputs.matrix) }}
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Python í™˜ê²½ ì„¤ì •
        uses: actions/setup-python@v4
        with:
          python-version: ${{ env.PYTHON_VERSION }}
      
      - name: ë¹Œë“œ ë„êµ¬ ì„¤ì¹˜
        run: |
          python -m pip install --upgrade pip build twine
      
      - name: íŒ¨í‚¤ì§€ ë¹Œë“œ
        run: |
          cd packages/${{ matrix.module }}
          python -m build

      - name: ë¹Œë“œ ì•„í‹°íŒ©íŠ¸ ì—…ë¡œë“œ
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.module }}-dist
          path: packages/${{ matrix.module }}/dist/

  # ë¬¸ì„œ ì—…ë°ì´íŠ¸
  documentation:
    name: "ë¬¸ì„œ ì—…ë°ì´íŠ¸"
    runs-on: ubuntu-latest
    needs: [detect-changes, build]
    strategy:
      matrix: ${{ fromJson(needs.detect-changes.outputs.matrix) }}
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0
      
      - name: Python í™˜ê²½ ì„¤ì •
        uses: actions/setup-python@v4
        with:
          python-version: ${{ env.PYTHON_VERSION }}
      
      - name: ë¬¸ì„œ ìƒì„± ë„êµ¬ ì„¤ì¹˜
        run: |
          python -m pip install --upgrade pip
          pip install toml pydantic typing-extensions
          cd packages/${{ matrix.module }}
          pip install -e ".[dev]" || pip install -e .
      
      - name: ê¸°ìˆ ëª…ì„¸ì„œ ì—…ë°ì´íŠ¸
        run: |
          python scripts/update-documentation.py ${{ matrix.module }}
      
      - name: ë³€ê²½ì‚¬í•­ í™•ì¸
        id: check-changes
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          
          if git diff --quiet packages/${{ matrix.module }}/docs/; then
            echo "changes=false" >> $GITHUB_OUTPUT
            echo "ğŸ“„ ${{ matrix.module }}: ë¬¸ì„œ ë³€ê²½ì‚¬í•­ ì—†ìŒ"
          else
            echo "changes=true" >> $GITHUB_OUTPUT
            echo "ğŸ“ ${{ matrix.module }}: ë¬¸ì„œ ì—…ë°ì´íŠ¸ ê°ì§€"
            git diff --name-only packages/${{ matrix.module }}/docs/
          fi
      
      - name: ë¬¸ì„œ ë³€ê²½ì‚¬í•­ ì»¤ë°‹
        if: steps.check-changes.outputs.changes == 'true'
        run: |
          git add packages/${{ matrix.module }}/docs/
          git commit -m "docs(${{ matrix.module }}): ê¸°ìˆ ëª…ì„¸ì„œ ìë™ ì—…ë°ì´íŠ¸
          
          - API ë¬¸ì„œ ë™ê¸°í™”
          - ì½”ë“œ êµ¬ì¡° ë¶„ì„ ë°˜ì˜
          - ì„±ëŠ¥ ë©”íŠ¸ë¦­ ì—…ë°ì´íŠ¸
          
          [skip ci]"
      
      - name: ë¬¸ì„œ ì•„í‹°íŒ©íŠ¸ ì—…ë¡œë“œ
        uses: actions/upload-artifact@v4
        with:
          name: docs-${{ matrix.module }}
          path: packages/${{ matrix.module }}/docs/

  # ë¬¸ì„œ í†µí•© ë° í‘¸ì‹œ
  docs-consolidate:
    name: "ë¬¸ì„œ í†µí•© ë° í‘¸ì‹œ"
    runs-on: ubuntu-latest
    needs: [detect-changes, documentation]
    if: github.ref == 'refs/heads/main'
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0
      
      - name: Git ì„¤ì •
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
      
      - name: ìµœì‹  ë³€ê²½ì‚¬í•­ ê°€ì ¸ì˜¤ê¸°
        run: |
          git pull origin main
      
      - name: ëª¨ë“  ë¬¸ì„œ ì•„í‹°íŒ©íŠ¸ ë‹¤ìš´ë¡œë“œ
        uses: actions/download-artifact@v4
        with:
          pattern: docs-*
          path: ./docs-artifacts
      
      - name: ë¬¸ì„œ ì•„í‹°íŒ©íŠ¸ ë³µì›
        run: |
          modules=(git-data-parser http-api-client llm-service notification-service notion-sync)
          for module in "${modules[@]}"; do
            if [ -d "./docs-artifacts/docs-$module" ]; then
              echo "ğŸ“„ $module ë¬¸ì„œ ë³µì› ì¤‘..."
              cp -r "./docs-artifacts/docs-$module/"* "packages/$module/docs/" || true
            fi
          done
      
      - name: í†µí•© ë¬¸ì„œ ë³€ê²½ì‚¬í•­ í™•ì¸ ë° í‘¸ì‹œ
        run: |
          if ! git diff --quiet packages/*/docs/; then
            echo "ğŸ“š í†µí•© ë¬¸ì„œ ì—…ë°ì´íŠ¸ ê°ì§€"
            git add packages/*/docs/
            git commit -m "docs: ëª¨ë“ˆ ê¸°ìˆ ëª…ì„¸ì„œ ìë™ ì—…ë°ì´íŠ¸
            
            ğŸ¤– ìë™ ìƒì„±ëœ ë¬¸ì„œ ì—…ë°ì´íŠ¸:
            - ì²˜ë¦¬ëœ ëª¨ë“ˆ: git-data-parser http-api-client llm-service notification-service notion-sync
            - API êµ¬ì¡° ë¶„ì„ ë° ë™ê¸°í™”
            - ì½”ë“œ ë³€ê²½ì‚¬í•­ ë°˜ì˜
            - ì„±ëŠ¥ ë©”íŠ¸ë¦­ ë° ì‚¬ìš©ë²• ì—…ë°ì´íŠ¸
            
            [skip ci]" || echo "ì»¤ë°‹í•  ë³€ê²½ì‚¬í•­ì´ ì—†ìŠµë‹ˆë‹¤."
            
            git push origin main || echo "í‘¸ì‹œí•  ë³€ê²½ì‚¬í•­ì´ ì—†ìŠµë‹ˆë‹¤."
            echo "âœ… ë¬¸ì„œ ì—…ë°ì´íŠ¸ ì™„ë£Œ"
          else
            echo "ğŸ“„ ë¬¸ì„œ ë³€ê²½ì‚¬í•­ ì—†ìŒ"
          fi

  # PyPI ë°°í¬ (main ë¸Œëœì¹˜ë§Œ)
  deploy:
    name: "PyPI ë°°í¬"
    runs-on: ubuntu-latest
    needs: [detect-changes, build, docs-consolidate]
    if: github.ref == 'refs/heads/main'
    strategy:
      matrix: ${{ fromJson(needs.detect-changes.outputs.matrix) }}
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: Python í™˜ê²½ ì„¤ì •
        uses: actions/setup-python@v4
        with:
          python-version: ${{ env.PYTHON_VERSION }}
      
      - name: ë„êµ¬ ì„¤ì¹˜
        run: |
          python -m pip install --upgrade pip twine toml semver
      
      - name: ë¹Œë“œ ì•„í‹°íŒ©íŠ¸ ë‹¤ìš´ë¡œë“œ
        uses: actions/download-artifact@v4
        with:
          name: ${{ matrix.module }}-dist
          path: packages/${{ matrix.module }}/dist/
      
      - name: ë²„ì „ ë³€ê²½ í™•ì¸
        id: version-check
        run: |
          cd packages/${{ matrix.module }}
          current_version=$(python -c "import toml; print(toml.load('pyproject.toml')['project']['version'])")
          
          # ì´ì „ íƒœê·¸ì™€ ë¹„êµ
          latest_tag=$(git tag -l "${{ matrix.module }}-v*" --sort=-version:refname | head -n1)
          if [ -n "$latest_tag" ]; then
            latest_version=${latest_tag#${{ matrix.module }}-v}
            if [ "$current_version" != "$latest_version" ]; then
              echo "version-changed=true" >> $GITHUB_OUTPUT
              echo "new-version=$current_version" >> $GITHUB_OUTPUT
              echo "ğŸ“¦ ${{ matrix.module }}: ë²„ì „ ë³€ê²½ ê°ì§€ ($latest_version â†’ $current_version)"
            else
              echo "version-changed=false" >> $GITHUB_OUTPUT
              echo "ğŸ“¦ ${{ matrix.module }}: ë²„ì „ ë³€ê²½ ì—†ìŒ ($current_version)"
            fi
          else
            echo "version-changed=true" >> $GITHUB_OUTPUT
            echo "new-version=$current_version" >> $GITHUB_OUTPUT
            echo "ğŸ“¦ ${{ matrix.module }}: ì²« ë²ˆì§¸ ë°°í¬ ($current_version)"
          fi
      
      - name: Git íƒœê·¸ ìƒì„±
        if: steps.version-check.outputs.version-changed == 'true'
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git tag -a "${{ matrix.module }}-v${{ steps.version-check.outputs.new-version }}" -m "${{ matrix.module }} v${{ steps.version-check.outputs.new-version }}"
          git push origin "${{ matrix.module }}-v${{ steps.version-check.outputs.new-version }}"
          echo "ğŸ·ï¸ íƒœê·¸ ìƒì„±: ${{ matrix.module }}-v${{ steps.version-check.outputs.new-version }}"
      
      - name: PyPI ë°°í¬
        if: steps.version-check.outputs.version-changed == 'true'
        env:
          TWINE_USERNAME: __token__
          TWINE_PASSWORD: ${{ secrets.PYPI_API_TOKEN }}
        run: |
          cd packages/${{ matrix.module }}
          if [ -n "${{ secrets.PYPI_API_TOKEN }}" ]; then
            echo "ğŸš€ PyPI ë°°í¬ ì‹œì‘: ${{ matrix.module }} v${{ steps.version-check.outputs.new-version }}"
            # ì‹¤ì œ ë°°í¬ ì „ ê²€ì¦
            twine check dist/*
            echo "ğŸ“¦ íŒ¨í‚¤ì§€ ê²€ì¦ ì™„ë£Œ"
            
            # ì‹¤ì œ ë°°í¬
            twine upload dist/* --verbose
            echo "âœ… PyPI ë°°í¬ ì™„ë£Œ: https://pypi.org/project/universal-${{ matrix.module }}/"
          else
            echo "âš ï¸ PYPI_API_TOKENì´ ì„¤ì •ë˜ì§€ ì•Šì•„ ë°°í¬ë¥¼ ê±´ë„ˆëœë‹ˆë‹¤."
            echo "ğŸ“¦ íŒ¨í‚¤ì§€ ê²€ì¦ë§Œ ìˆ˜í–‰í•©ë‹ˆë‹¤:"
            twine check dist/*
            echo "ë°°í¬ ì‹œë®¬ë ˆì´ì…˜: ${{ matrix.module }} v${{ steps.version-check.outputs.new-version }}"
          fi
      
      - name: GitHub Release ìƒì„±
        if: steps.version-check.outputs.version-changed == 'true'
        uses: softprops/action-gh-release@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: ${{ matrix.module }}-v${{ steps.version-check.outputs.new-version }}
          name: ${{ matrix.module }} v${{ steps.version-check.outputs.new-version }}
          body: |
            ## ${{ matrix.module }} v${{ steps.version-check.outputs.new-version }}
            
            ğŸš€ **ìë™ ë°°í¬ëœ ë¦´ë¦¬ìŠ¤ì…ë‹ˆë‹¤.**
            
            ### ğŸ“¦ ì„¤ì¹˜ ë°©ë²•
            ```bash
            pip install universal-${{ matrix.module }}==${{ steps.version-check.outputs.new-version }}
            ```
            
            ### ğŸ“š ë¬¸ì„œ
            - [ê¸°ìˆ ëª…ì„¸ì„œ](https://github.com/${{ github.repository }}/blob/main/packages/${{ matrix.module }}/docs/technical-specification.md)
            - [PyPI í˜ì´ì§€](https://pypi.org/project/universal-${{ matrix.module }}/)
            
            ### ğŸ”— ë§í¬
            - [GitHub Actions ë¡œê·¸](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})
            - [ì „ì²´ ë³€ê²½ì‚¬í•­](https://github.com/${{ github.repository }}/compare/${{ matrix.module }}-v${{ steps.version-check.outputs.new-version }}...main)
          draft: false
          prerelease: false

  # ì•Œë¦¼
  notify:
    name: "ë°°í¬ ì•Œë¦¼"
    runs-on: ubuntu-latest
    needs: [detect-changes, quality-check, test, build, documentation, docs-consolidate, deploy]
    if: always()
    
    steps:
      - name: ë³€ê²½ì‚¬í•­ ì—†ìŒ ì•Œë¦¼
        if: needs.detect-changes.outputs.has-changes == 'false'
        run: |
          echo "ğŸ“„ ë³€ê²½ëœ ëª¨ë“ˆì´ ì—†ì–´ ë°°í¬ë¥¼ ê±´ë„ˆëœë‹ˆë‹¤."

      - name: ë°°í¬ ì„±ê³µ ì•Œë¦¼
        if: needs.detect-changes.outputs.has-changes == 'true' && needs.deploy.result == 'success'
        run: |
          if [ -n "${{ secrets.SLACK_WEBHOOK_URL }}" ]; then
            curl -X POST -H 'Content-type: application/json' \
              --data '{
                "text": "ğŸš€ Universal Modules ë°°í¬ ì„±ê³µ!",
                "blocks": [
                  {
                    "type": "header",
                    "text": {
                      "type": "plain_text",
                      "text": "ğŸš€ ë°°í¬ ì™„ë£Œ"
                    }
                  },
                  {
                    "type": "section",
                    "fields": [
                      {
                        "type": "mrkdwn",
                        "text": "*ë°°í¬ëœ ëª¨ë“ˆ:*\n${{ needs.detect-changes.outputs.changed-modules }}"
                      },
                      {
                        "type": "mrkdwn",
                        "text": "*ë¸Œëœì¹˜:*\n${{ github.ref_name }}"
                      },
                      {
                        "type": "mrkdwn",
                        "text": "*ì»¤ë°‹:*\n<${{ github.server_url }}/${{ github.repository }}/commit/${{ github.sha }}|${{ github.sha }}>"
                      },
                      {
                        "type": "mrkdwn",
                        "text": "*ì‘ì„±ì:*\n${{ github.actor }}"
                      }
                    ]
                  },
                  {
                    "type": "actions",
                    "elements": [
                      {
                        "type": "button",
                        "text": {
                          "type": "plain_text",
                          "text": "GitHub Actions ë³´ê¸°"
                        },
                        "url": "${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
                      },
                      {
                        "type": "button",
                        "text": {
                          "type": "plain_text",
                          "text": "PyPI í™•ì¸"
                        },
                        "url": "https://pypi.org/search/?q=universal"
                      }
                    ]
                  }
                ]
              }' \
              ${{ secrets.SLACK_WEBHOOK_URL }}
          else
            echo "SLACK_WEBHOOK_URLì´ ì„¤ì •ë˜ì§€ ì•Šì•„ Slack ì•Œë¦¼ì„ ê±´ë„ˆëœë‹ˆë‹¤."
          fi

      - name: ì½”ë“œ í’ˆì§ˆ ê²€ì‚¬ ì‹¤íŒ¨ ì•Œë¦¼
        if: needs.detect-changes.outputs.has-changes == 'true' && needs.quality-check.result == 'failure'
        run: |
          if [ -n "${{ secrets.SLACK_WEBHOOK_URL }}" ]; then
            curl -X POST -H 'Content-type: application/json' \
              --data '{
                "text": "âš ï¸ Universal Modules ì½”ë“œ í’ˆì§ˆ ê²€ì‚¬ ì‹¤íŒ¨!",
                "blocks": [
                  {
                    "type": "header",
                    "text": {
                      "type": "plain_text",
                      "text": "âš ï¸ ì½”ë“œ í’ˆì§ˆ ê²€ì‚¬ ì‹¤íŒ¨"
                    }
                  },
                  {
                    "type": "section",
                    "text": {
                      "type": "mrkdwn",
                      "text": "*ëª¨ë“ˆ:* ${{ needs.detect-changes.outputs.changed-modules }}\n*ë¸Œëœì¹˜:* ${{ github.ref_name }}\n*ì‘ì„±ì:* ${{ github.actor }}"
                    }
                  },
                  {
                    "type": "actions",
                    "elements": [
                      {
                        "type": "button",
                        "text": {
                          "type": "plain_text",
                          "text": "í’ˆì§ˆ ê²€ì‚¬ ë¡œê·¸ ë³´ê¸°"
                        },
                        "url": "${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}",
                        "style": "primary"
                      }
                    ]
                  }
                ]
              }' \
              ${{ secrets.SLACK_WEBHOOK_URL }}
          else
            echo "SLACK_WEBHOOK_URLì´ ì„¤ì •ë˜ì§€ ì•Šì•„ Slack ì•Œë¦¼ì„ ê±´ë„ˆëœë‹ˆë‹¤."
          fi

      - name: í…ŒìŠ¤íŠ¸ ì‹¤íŒ¨ ì•Œë¦¼
        if: needs.detect-changes.outputs.has-changes == 'true' && needs.test.result == 'failure'
        run: |
          if [ -n "${{ secrets.SLACK_WEBHOOK_URL }}" ]; then
            curl -X POST -H 'Content-type: application/json' \
              --data '{
                "text": "âŒ Universal Modules í…ŒìŠ¤íŠ¸ ì‹¤íŒ¨!",
                "blocks": [
                  {
                    "type": "header",
                    "text": {
                      "type": "plain_text",
                      "text": "âŒ í…ŒìŠ¤íŠ¸ ì‹¤íŒ¨"
                    }
                  },
                  {
                    "type": "section",
                    "text": {
                      "type": "mrkdwn",
                      "text": "*ëª¨ë“ˆ:* ${{ needs.detect-changes.outputs.changed-modules }}\n*ë¸Œëœì¹˜:* ${{ github.ref_name }}\n*ì‘ì„±ì:* ${{ github.actor }}"
                    }
                  },
                  {
                    "type": "actions",
                    "elements": [
                      {
                        "type": "button",
                        "text": {
                          "type": "plain_text",
                          "text": "í…ŒìŠ¤íŠ¸ ë¡œê·¸ ë³´ê¸°"
                        },
                        "url": "${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}",
                        "style": "danger"
                      }
                    ]
                  }
                ]
              }' \
              ${{ secrets.SLACK_WEBHOOK_URL }}
          else
            echo "SLACK_WEBHOOK_URLì´ ì„¤ì •ë˜ì§€ ì•Šì•„ Slack ì•Œë¦¼ì„ ê±´ë„ˆëœë‹ˆë‹¤."
          fi

      - name: ë¹Œë“œ ì‹¤íŒ¨ ì•Œë¦¼
        if: needs.detect-changes.outputs.has-changes == 'true' && needs.build.result == 'failure'
        run: |
          if [ -n "${{ secrets.SLACK_WEBHOOK_URL }}" ]; then
            curl -X POST -H 'Content-type: application/json' \
              --data '{
                "text": "ğŸ”¨ Universal Modules ë¹Œë“œ ì‹¤íŒ¨!",
                "blocks": [
                  {
                    "type": "header",
                    "text": {
                      "type": "plain_text",
                      "text": "ğŸ”¨ ë¹Œë“œ ì‹¤íŒ¨"
                    }
                  },
                  {
                    "type": "section",
                    "text": {
                      "type": "mrkdwn",
                      "text": "*ëª¨ë“ˆ:* ${{ needs.detect-changes.outputs.changed-modules }}\n*ë¸Œëœì¹˜:* ${{ github.ref_name }}\n*ì‘ì„±ì:* ${{ github.actor }}"
                    }
                  },
                  {
                    "type": "actions",
                    "elements": [
                      {
                        "type": "button",
                        "text": {
                          "type": "plain_text",
                          "text": "ë¹Œë“œ ë¡œê·¸ ë³´ê¸°"
                        },
                        "url": "${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}",
                        "style": "danger"
                      }
                    ]
                  }
                ]
              }' \
              ${{ secrets.SLACK_WEBHOOK_URL }}
          else
            echo "SLACK_WEBHOOK_URLì´ ì„¤ì •ë˜ì§€ ì•Šì•„ Slack ì•Œë¦¼ì„ ê±´ë„ˆëœë‹ˆë‹¤."
          fi

      - name: ë¬¸ì„œ ì—…ë°ì´íŠ¸ ì‹¤íŒ¨ ì•Œë¦¼
        if: needs.detect-changes.outputs.has-changes == 'true' && needs.documentation.result == 'failure'
        run: |
          if [ -n "${{ secrets.SLACK_WEBHOOK_URL }}" ]; then
            curl -X POST -H 'Content-type: application/json' \
              --data '{
                "text": "ğŸ“š Universal Modules ë¬¸ì„œ ì—…ë°ì´íŠ¸ ì‹¤íŒ¨!",
                "blocks": [
                  {
                    "type": "header",
                    "text": {
                      "type": "plain_text",
                      "text": "ğŸ“š ë¬¸ì„œ ì—…ë°ì´íŠ¸ ì‹¤íŒ¨"
                    }
                  },
                  {
                    "type": "section",
                    "text": {
                      "type": "mrkdwn",
                      "text": "*ëª¨ë“ˆ:* ${{ needs.detect-changes.outputs.changed-modules }}\n*ë¸Œëœì¹˜:* ${{ github.ref_name }}\n*ì‘ì„±ì:* ${{ github.actor }}"
                    }
                  },
                  {
                    "type": "actions",
                    "elements": [
                      {
                        "type": "button",
                        "text": {
                          "type": "plain_text",
                          "text": "ë¬¸ì„œ ë¡œê·¸ ë³´ê¸°"
                        },
                        "url": "${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}",
                        "style": "primary"
                      }
                    ]
                  }
                ]
              }' \
              ${{ secrets.SLACK_WEBHOOK_URL }}
          else
            echo "SLACK_WEBHOOK_URLì´ ì„¤ì •ë˜ì§€ ì•Šì•„ Slack ì•Œë¦¼ì„ ê±´ë„ˆëœë‹ˆë‹¤."
          fi

      - name: ë°°í¬ ì‹¤íŒ¨ ì•Œë¦¼
        if: needs.detect-changes.outputs.has-changes == 'true' && needs.deploy.result == 'failure'
        run: |
          if [ -n "${{ secrets.SLACK_WEBHOOK_URL }}" ]; then
            curl -X POST -H 'Content-type: application/json' \
              --data '{
                "text": "âŒ Universal Modules ë°°í¬ ì‹¤íŒ¨!",
                "blocks": [
                  {
                    "type": "header",
                    "text": {
                      "type": "plain_text",
                      "text": "âŒ ë°°í¬ ì‹¤íŒ¨"
                    }
                  },
                  {
                    "type": "section",
                    "fields": [
                      {
                        "type": "mrkdwn",
                        "text": "*ì‹¤íŒ¨í•œ ëª¨ë“ˆ:*\n${{ needs.detect-changes.outputs.changed-modules }}"
                      },
                      {
                        "type": "mrkdwn",
                        "text": "*ë¸Œëœì¹˜:*\n${{ github.ref_name }}"
                      },
                      {
                        "type": "mrkdwn",
                        "text": "*ì»¤ë°‹:*\n<${{ github.server_url }}/${{ github.repository }}/commit/${{ github.sha }}|${{ github.sha }}>"
                      },
                      {
                        "type": "mrkdwn",
                        "text": "*ì‘ì„±ì:*\n${{ github.actor }}"
                      }
                    ]
                  },
                  {
                    "type": "actions",
                    "elements": [
                      {
                        "type": "button",
                        "text": {
                          "type": "plain_text",
                          "text": "ë¡œê·¸ í™•ì¸í•˜ê¸°"
                        },
                        "url": "${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}",
                        "style": "danger"
                      }
                    ]
                  }
                ]
              }' \
              ${{ secrets.SLACK_WEBHOOK_URL }}
          else
            echo "SLACK_WEBHOOK_URLì´ ì„¤ì •ë˜ì§€ ì•Šì•„ Slack ì•Œë¦¼ì„ ê±´ë„ˆëœë‹ˆë‹¤."
          fi

      - name: ì „ì²´ ì›Œí¬í”Œë¡œìš° ì„±ê³µ ì•Œë¦¼
        if: needs.detect-changes.outputs.has-changes == 'true' && needs.deploy.result == 'skipped' && !contains(needs.*.result, 'failure')
        run: |
          if [ -n "${{ secrets.SLACK_WEBHOOK_URL }}" ]; then
            curl -X POST -H 'Content-type: application/json' \
              --data '{
                "text": "âœ… Universal Modules ì²˜ë¦¬ ì™„ë£Œ (ë°°í¬ ì—†ìŒ)",
                "blocks": [
                  {
                    "type": "header",
                    "text": {
                      "type": "plain_text",
                      "text": "âœ… ì²˜ë¦¬ ì™„ë£Œ"
                    }
                  },
                  {
                    "type": "section",
                    "text": {
                      "type": "mrkdwn",
                      "text": "*ëª¨ë“ˆ:* ${{ needs.detect-changes.outputs.changed-modules }}\n*ìƒíƒœ:* í…ŒìŠ¤íŠ¸/ë¹Œë“œ ì„±ê³µ, ë²„ì „ ë³€ê²½ ì—†ì–´ ë°°í¬ ìŠ¤í‚µ\n*ë¸Œëœì¹˜:* ${{ github.ref_name }}\n*ì‘ì„±ì:* ${{ github.actor }}"
                    }
                  },
                  {
                    "type": "actions",
                    "elements": [
                      {
                        "type": "button",
                        "text": {
                          "type": "plain_text",
                          "text": "ì›Œí¬í”Œë¡œìš° ë¡œê·¸ ë³´ê¸°"
                        },
                        "url": "${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
                      }
                    ]
                  }
                ]
              }' \
              ${{ secrets.SLACK_WEBHOOK_URL }}
          else
            echo "SLACK_WEBHOOK_URLì´ ì„¤ì •ë˜ì§€ ì•Šì•„ Slack ì•Œë¦¼ì„ ê±´ë„ˆëœë‹ˆë‹¤."
          fi 